@using Sandbox;
@using Sandbox.UI;
@using TacticsRPG;
@inherits PanelComponent
@namespace Sandbox

<root>
	@if(!IsActive)return;
	{
		<img class="pointer" @ref="ImgPanel" src="ui/triangle.png" />
		<CommandMenu @ref="CMenu" />
		<ActMenu @ref="AMenu" />
		<AbilityMenu @ref="AbiMenu" />
	}

</root>

@code
{
	//CONDENSE ALL ABILITYITEM MENUS TO ONE MENU!!! (SKILL, SPELL, ITEM)
	//Refactor Asap
	
	[Property] public bool IsActive {get; set;} = false;
	[Property] BattleUnit ActiveUnit {get; set;} = null;
	[Property] public MenuState? State {get; set;} = MenuState.Command;
	[Property] public MenuState? LastState {get; set;} = null;
	[Property] public int MenuLevel {get; set;} = 0;
	[Property] public int YValue {get; set;} = 470;
	public CommandMenu CMenu {get; set;}
	public ActMenu AMenu {get; set;}
	public AbilityMenu AbiMenu {get; set;}
	[Property] SoundEvent SelectSound {get; set;}
	[Property] SoundEvent PressSound {get; set;}
	[Property] SoundEvent BackSound {get; set;}

	public bool HasInjected = false;
	public float InjectBufer = 0.05f;
	public TimeSince SinceActivated;

	public event Action<CommandType?, CommandItem> ActionSelected;

	private Image ImgPanel;

	protected override void OnAwake()
	{
		PlayerEvents.FocusModeChange -= HandlePlayerFocusMode;	
		PlayerEvents.FocusModeChange += HandlePlayerFocusMode;

	}

	protected override void OnDestroy()
	{
		Log.Info("Action Menu Destroyed");
		PlayerEvents.FocusModeChange -= HandlePlayerFocusMode;	
	}
	
	public void HandlePlayerFocusMode(FocusMode? mode, BattleUnit u)
	{
		Log.Info("Handling Focus Event");
		switch(mode)
		{
			case FocusMode.Menu:
				ActivateMenu(u);
				break;
			default:
				DeactivateMenu();
				break;
		}
	}
	public void ActivateMenu(BattleUnit u)
	{
		Log.Info($"Menu {u}");
		IsActive = true;
		ActiveUnit = u;
		SinceActivated = 0f;

	}

	//Hacky Solution
	public void InjectUnit()
	{
		if(!IsActive) return;
		CMenu.ActiveUnit = ActiveUnit;
		AMenu.ActiveUnit = ActiveUnit;
		AbiMenu.ActiveUnit = ActiveUnit;

		HasInjected = true;
	}

	public void InjectRoot()
	{
		CMenu.RootMenu = this;
		AMenu.RootMenu = this;
		AbiMenu.RootMenu = this;
	}


	public void DeactivateMenu()
	{
		IsActive = false;
		HasInjected = false;
	}

	protected override void OnUpdate()
	{
		if(!IsActive) return;
		if(!HasInjected && SinceActivated >= InjectBufer)
		{
			InjectRoot();
			InjectUnit();
		}
		if(!HasInjected) return;
		switch(State)
		{

			case MenuState.Command:
				if(!CMenu.IsValid()) return;
				if(!CMenu.IsActive) return;
				if(!CMenu.ActiveUnit.IsValid()) return;
				if(CMenu.Menu is null) return;
				if(!CMenu.Menu.IsVisible) return;
				CMenu.Menu.Style.Top = Length.Pixels(YValue);
				var CMenuPos = CMenu.Menu.Box.Rect.Position / Panel.ScaleToScreen;
				ImgPanel.Style.Top = CMenuPos.y + (34 * CMenu.SelectedIndex);
				ImgPanel.Style.Left = CMenuPos.x -20 ;
				break;
			case MenuState.Action:
				if(!AMenu.IsValid()) return;
				if(!AMenu.IsActive) return;
				AMenu.Menu.Style.Top = Length.Pixels(YValue);
				var AMenuPos = AMenu.Menu.Box.Rect.Position / Panel.ScaleToScreen;
				ImgPanel.Style.Top = AMenuPos.y + (34 * AMenu.SelectedIndex);
				ImgPanel.Style.Left = AMenuPos.x -20 ;
				break;
			case MenuState.Ability:
				if(!AbiMenu.IsValid()) return;
				if(!AbiMenu.IsActive) return;
				AbiMenu.Menu.Style.Top = Length.Pixels(YValue);
				var AbiMenuPos = AbiMenu.Menu.Box.Rect.Position / Panel.ScaleToScreen;
				ImgPanel.Style.Top = AbiMenuPos.y + (34 * AbiMenu.SelectedIndex);
				ImgPanel.Style.Left = AbiMenuPos.x -20 ;
				break;
		}

	}

	public void DoReset()
	{
		State = MenuState.Command;
		LastState = null;
		MenuLevel = 0;
	}
	
	public void ActionMenuSelect(string text, string skillsetID = null)
	{
		if(text == "ATTACK")
		{
			PlayerMaster.Instance.SelectedCommand(CommandType.Attack, ActiveUnit.Command.ActionCommands[CMenu.SelectedIndex]);
			Log.Info($"ATTACK Selected");
		}
		else
		{
			ChangeMenuState(MenuState.Ability, skillsetID);
		}
	}
	public void ChangeMenuState(MenuState? state, string data = null)
	{
		switch(state)
		{
			case MenuState.Command:
				break;
			case MenuState.Action:
				if(State == MenuState.Command)
				{

					LastState = State;
					State = state;
					NextMenuState();
					CMenu.IsGrey = true;
					CMenu.SetTransform(MenuLevel);
					AMenu.Activate();			
				}
				break;
			case MenuState.Ability:
				if(State == MenuState.Action)
				{
					LastState = State;
					State = state;
					NextMenuState();
					AMenu.IsGrey = true;
					CMenu.SetTransform(MenuLevel);
					AMenu.SetTransform(MenuLevel);
					AbiMenu.SkillsetID = data;
					AbiMenu.SetAbilityCommands();
					AbiMenu.Activate();
					Log.Info($"Ability Menu Activated. SkillsetID: {data}");
				}
				break;
		}
	}

	public void LastMenuState()
	{
		switch(State)
		{
			case MenuState.Action:
				State = MenuState.Command;
				Log.Info(State);
				AMenu.Deactivate();
				BackMenuState();
				CMenu.IsGrey = false;
				CMenu.SetTransform(0);
				Sound.Play(BackSound);
				break;
			case MenuState.Ability:
				State = MenuState.Action;
				Log.Info(State);
				AbiMenu.Deactivate();
				BackMenuState();
				AMenu.IsGrey = false;
				AMenu.ZeroTransform();
				CMenu.SetTransform(MenuLevel);
				Sound.Play(BackSound);
				break;
		}
	}
	public void NextMenuState()
	{
		MenuLevel++;
	}

	public void BackMenuState()
	{
		MenuLevel--;
	}

	public void IncreaseIndex()
	{
		switch(State)
		{
			case MenuState.Command:
				CMenu.IncreaseIndex();
				Sound.Play(SelectSound);
				break;
			case MenuState.Action:
				AMenu.IncreaseIndex();
				Sound.Play(SelectSound);
				break;
			case MenuState.Ability:
				AbiMenu.IncreaseIndex();
				Sound.Play(SelectSound);
				break;
		}
	}

	public void DecreaseIndex()
	{
		switch(State)
		{
			case MenuState.Command:
				CMenu.DecreaseIndex();
				Sound.Play(SelectSound);
				break;
			case MenuState.Action:
				AMenu.DecreaseIndex();
				Sound.Play(SelectSound);
				break;
			case MenuState.Ability:
				AbiMenu.DecreaseIndex();
				Sound.Play(SelectSound);
				break;
		}
	}

	public void SelectItem()
	{
		switch(State)
		{
			case MenuState.Command:
				CMenu.SelectCommand();
				ActionSelected?.Invoke(CMenu.GetCommandFromString(ActiveUnit.Command.CommandItems[CMenu.SelectedIndex].Text), ActiveUnit.Command.CommandItems[CMenu.SelectedIndex]);
				Sound.Play(PressSound);
				break;
			case MenuState.Action:
				AMenu.SelectMenuItem();
				ActionSelected?.Invoke(CommandType.Action, ActiveUnit.Command.ActionCommands[AMenu.SelectedIndex]);
				Sound.Play(PressSound);
				break;
			case MenuState.Ability:
				AbiMenu.SelectMenuItem();
				ActionSelected?.Invoke(CommandType.Ability, ActiveUnit.Command.AbilityCommands[AMenu.SelectedIndex]);
				Sound.Play(PressSound);
				break;
		}
	}


	
	protected override int BuildHash() => System.HashCode.Combine(RealTime.Now);
}
