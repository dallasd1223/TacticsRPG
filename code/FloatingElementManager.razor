@using Sandbox;
@using Sandbox.UI;
@using TacticsRPG;
@inherits PanelComponent
@namespace Sandbox

<root>
</root>

@code
{
	private Queue<IFloatingElement> ElementsQueue = new Queue<IFloatingElement>();
	private List<IFloatingElement> ActiveElements = new List<IFloatingElement>();

	[Property] private int AmountInQueue = 0;
	[Property] private int AmountLoopActive = 0;
	[Property] private int AmountOnceActive = 0;

	private TimeSince TimeSinceOnceQueued = 0f;
	private TimeSince TimeSinceOnceActiveClear = 0f;

	[Property] private bool IsPlaying = false;
	[Property] private bool IsCluster = false;
	[Property] private bool HasCleared = true;

	public event Action ClearedActiveOnceElements;

	[Property] public SoundEvent LVLUPSound {get; set;}
	[Property] public SoundEvent JobUPSound {get; set;}

	[Button("DamageTest")]
	public void ElemTest()
	{
		CreateIntValueText(999, new Color(1.00f, 1.00f, 1.00f, 1.00f));
	}

	[Button("ExpTest")]
	public void GiveExp()
	{
		CreateEXPText(150);
	}

	[Button("JobEXP")]
	public void JobTest()
	{
		CreateJPText(17);
	}

	[Button("JobUP")]
	public void JobUpTest()
	{
		CreateJobUpText();
	}

	[Button("LVLUP")]
	public void LVLUPTest()
	{
		CreateLVLUPText();
	}
	public void CreateIntValueText(int amount, Color col)
	{
		CreateFloatingText(amount.ToString(), col, 60, "ThaleahFat", FloatingTextMode.Normal, () => new CharAnimationSequence(new BounceInAnimation(), new FadeOutAnimation(0.5f)));
	}
	public void CreateEXPText(int amount)
	{
		CreateFloatingText($"EXP {amount}", new Color(1.00f, 0.93f, 0.00f, 1.00f), 40, "ThaleahFat", FloatingTextMode.Normal, () => new CharAnimationSequence(new BounceInAnimation(), new FadeOutAnimation(0.5f)));
	}
	public void CreateJPText(int amount)
	{
		CreateFloatingText($"JP {amount}", new Color(1.00f, 0.93f, 0.00f, 1.00f), 40, "ThaleahFat", FloatingTextMode.Normal, () => new CharAnimationSequence(new BounceInAnimation(), new FadeOutAnimation(0.5f)));
	}
	public void CreateLVLUPText()
	{
		CreateFloatingText($"LVL UP", new Color(1.00f, 0.93f, 0.00f, 1.00f), 40,"ThaleahFat", FloatingTextMode.Typewriter, () => new ParallelAnimation(new RainbowColorAnimation(1.5f), new CharAnimationSequence(new BounceInAnimation(), new FadeOutAnimation(0.5f))));
		Sound.Play(LVLUPSound);	
	}

	public void CreateJobUpText()
	{
		CreateFloatingText($"Job UP", new Color(1.00f, 0.93f, 0.00f, 1.00f), 40,"ThaleahFat", FloatingTextMode.Typewriter, () => new ParallelAnimation(new RainbowColorAnimation(1.5f), new CharAnimationSequence(new BounceInAnimation(), new FadeOutAnimation(0.5f))));
		Sound.Play(JobUPSound);	
	}

	public void CreateFloatingText(string text, Color color, int size, string font, FloatingTextMode mode, Func<ICharAnimation> anim)
	{
		var ft = new FloatingText(text, font, size, color, mode, TextColorMode.Rainbow, anim);
		ft.Obj = this.GameObject.Parent;
		ElementsQueue.Enqueue(ft);
		AmountInQueue++;
		TimeSinceOnceQueued = 0f;
		Log.Info($"Total Elems: {AmountOnceActive + AmountInQueue}");
		if(AmountOnceActive + AmountInQueue > 1)
		{
			IsCluster = true;
		}
		HasCleared = false;
	}

	private void AddElem()
	{
		if(IsPlaying) return;
		var elem = ElementsQueue.Dequeue();
		AmountInQueue--;

		Panel.AddChild((Panel)elem);
		ActiveElements.Add(elem);

		if(elem.Type == ElementPlayType.Once)
		{
			AmountOnceActive++;
		}
		else if(elem.Type == ElementPlayType.Loop)
		{
			AmountLoopActive++;
		}

		elem.Start();

		IsPlaying = true;
	}

	private void RemoveElem(IFloatingElement elem)
	{
		ActiveElements.Remove(elem);
		if(elem.Type == ElementPlayType.Once)
		{
			AmountOnceActive--;
			if(AmountOnceActive == 0 && !ElementsQueue.Any())
			{
				TimeSinceOnceActiveClear = 0f;
			}
			
		}
		else if(elem.Type == ElementPlayType.Loop)
		{
			AmountLoopActive--;
		}

		var p = elem as Panel;
		p.Delete();

		IsPlaying = false;
		Log.Info("IsPlaying Set To False");
	}

	protected override void OnUpdate()
	{
		if(ElementsQueue.Any())
		{
			AddElem();
		}
		else
		{
			if(!HasCleared && AmountOnceActive == 0 && IsCluster && TimeSinceOnceActiveClear >= 0.5f)
			{
				IsCluster = false;
				HasCleared = true;
				ClearedActiveOnceElements?.Invoke();
				Log.Info("Active Elements Cluster Finished/Cleared");
			}
			else if(!HasCleared && AmountOnceActive == 0 && TimeSinceOnceActiveClear >= 0.5f)
			{
				HasCleared = true;
				ClearedActiveOnceElements?.Invoke();
				Log.Info("Active Elements Finished/Cleared");				
			}
		}
		DeleteReadyElements();
	}

	void DeleteReadyElements()
	{

		if(!ActiveElements.Any()) return;
		foreach(IFloatingElement e in ActiveElements)
		{
			if(e.ReadyToDelete)
			{
				RemoveElem(e);
				Log.Info("Removing Elem");
				if(!ActiveElements.Any()) return;
			}
		}
	}

	protected override int BuildHash() => System.HashCode.Combine(RealTime.Now);
}
